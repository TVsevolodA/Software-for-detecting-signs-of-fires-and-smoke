<html>
  <head>
    <meta charset="utf-8">
    <title>Monitoring</title>
    <!-- BootStrap -->
    <link href=" https://use.fontawesome.com/releases/v6.5.1/css/all.css" rel="stylesheet" >
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      #pageTitle {
        margin-bottom: 40px;
        text-align: center;
      }
      #streams {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
        align-items: center;
      }
      a { text-decoration:none; }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Главная</a></li>
            <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Управление БД</a></li>
            <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Отчетность</a></li>
            <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Роли</a></li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item">
              <button type="button" class="btn btn-outline-light text-dark" onclick="changeDisplay()">
                <i class="bi bi-grid-3x3 h1"></i>
              </button>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">
                <i class="bi bi-bell h1"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">
                <i class="bi bi-person-circle h1"></i>
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </header>
    <main>
      <div id="pageTitle">
        <h1>Видеотрансляции с камер</h1>
      </div>
      <div id="streams"></div>
    </main>
    <!-- BootStrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <!-- SocketIO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
      function changeSizeStream(imgs, w, h) {
        for (let i = 0; i < imgs.length; i++) {
          let image = imgs[i];
          image.style.width = `${w}px`;
          image.style.height = `${h}px`;
        }
      }

      function changeDisplay() {
        let streams = document.getElementById('streams');
        let gridView = document.getElementsByClassName('bi-grid-3x3')[0];
        let listView = document.getElementsByClassName('bi-list')[0];
        let images = document.getElementsByTagName('img');
        if (gridView === undefined) {
          listView.classList.remove('bi-list');
          listView.classList.add('bi-grid-3x3');
          streams.style.flexDirection = 'row';
          changeSizeStream(images, 350, 262.5);
        }
        else {
          gridView.classList.remove('bi-grid-3x3');
          gridView.classList.add('bi-list');
          streams.style.flexDirection = 'column';
          changeSizeStream(images, 450, 337.5);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const socket = io.connect('http://localhost:5050', {
          'reconnection': true,
          'reconnectionDelayMax': 5000,
          'reconnectionAttempts': 5
        });
        socket.on('connect', function() {
          for (let i = 0; i < cameraСounter; i++) {
            socket.emit('my_event', {data: i});
          }
        });
        socket.on("data", function(data) {
          let iconBell = document.getElementsByClassName('bi-bell')[0];
          if (iconBell !== undefined) {
            iconBell.classList.remove('bi-bell');
            iconBell.classList.add('bi-bell-fill');
          }
        });
      });

      // for (let i = 0; i < 50; i++) {
      //   let stream = document.createElement('div');
      //   stream.style.margin = '2%';
      //   stream.style.width = '300px';
      //   stream.style.height = '225px';
      //   stream.style.border = '2px solid black';
      //   document.getElementById('streams').append(stream);
      // }
      
      const cameras = '{{cameras|tojson}}';
      console.log(cameras);
      const cameraСounter = JSON.parse(cameras).length;
      for (let i = 0; i < cameraСounter; i++)
      {
        let stream = document.createElement('img');
        let url = "{{ url_for('video_feed', id='value') }}".replace('value', i);
        stream.style.margin = '2%';
        stream.style.width = '350px';
        stream.style.height = '262.5px';
        stream.src = url;
        stream.alt = 'Не удалось получить доступ к камере';
        document.getElementById('streams').append(stream);
      }
    </script>
  </body>
</html>